<!DOCTYPE html>
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  </head>
  <body onload="init();">
    <h1>Take a snapshot of the current video stream</h1>
   Click on the Start WebCam button.
     <p>
    <button onclick="startWebcam();">Start WebCam</button>
    <button onclick="stopWebcam();">Stop WebCam</button>
       <button id = "snap" onclick="snapshot();">Take Snapshot</button>
    </p>
    <video onclick="snapshot(this);" width="1280" height="720" controls autoplay></video>
  <p>
        Screenshots : </p>
      <canvas  id="myCanvas" width="1280" height="720"></canvas>
      <button id="confirm" onclick="processImage();">Confirm</button>

      <div id="wrapper" style="width:1020px; display:table;">
          <div id="jsonOutput" style="width:600px; display:table-cell;">
              Response:<br><br>

              <textarea id="responseTextArea" class="UIInput"
                        style="width:580px; height:400px;"></textarea>
          </div>
          <div id="imageDiv" style="width:420px; display:table-cell;">
              Source image:<br><br>

              <img id="sourceImage" width="400" />
          </div>
      </div>
  </body>
  <script>
      var canvas, ctx;
      var promise;
      var video = document.querySelector('video');
      var url;

        function init(){
          document.getElementById("snap").disabled=true;
        }

        function snapshot() {
        canvas = document.getElementById("myCanvas");
        ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0,0, canvas.width, canvas.height);
        url=canvas.toDataURL('image/webp',1.0)
        //var newImg = document.createElement("img"); // create img tag
        //newImg.src = url;
        //document.body.appendChild(newImg); // add to end of your document
        //console.log(url);
      }

      function startWebcam() {
        const constraints = {
          video: {width:{min:1280},height:{min:720}}
          };
          function handleSuccess(stream) {
            video.srcObject = stream;
            document.getElementById("snap").disabled=false;
            }

            function handleError(error) {
              console.error('Reeeejected!', error);
            }

            navigator.mediaDevices.getUserMedia(constraints).
            then(handleSuccess).catch(handleError);
          }
      function stopWebcam() {video.srcObject.getTracks()[0].stop()};

      makeblob = function (dataURL) {
            var BASE64_MARKER = ';base64,';
            if (dataURL.indexOf(BASE64_MARKER) == -1) {
                var parts = dataURL.split(',');
                var contentType = parts[0].split(':')[1];
                var raw = decodeURIComponent(parts[1]);
                return new Blob([raw], { type: contentType });
            }
            var parts = dataURL.split(BASE64_MARKER);
            var contentType = parts[0].split(':')[1];
            var raw = window.atob(parts[1]);
            var rawLength = raw.length;

            var uInt8Array = new Uint8Array(rawLength);

            for (var i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], { type: contentType });
        }

      function processImage(){
        var subscriptionKey = "d86d34f783a34b6c99fb393c6a72fe6e";
        var uriBase =
            "https://westcentralus.api.cognitive.microsoft.com/face/v1.0/detect";

        var params = {
            "returnFaceId": "true",
            "returnFaceLandmarks": "false",
            "returnFaceAttributes":
                "age,gender,headPose,smile,facialHair,glasses,emotion," +
                "hair,makeup,occlusion,accessories,blur,exposure,noise"
        };
        // Display the image.
        var sourceImageUrl = url ;//document.getElementById("inputImage").value;
        document.querySelector("#sourceImage").src = sourceImageUrl;  //It is displaying the image



        $.ajax({
            url: uriBase + "?" + $.param(params),

            // Request headers.
            beforeSend: function(xhrObj){
                //xhrObj.setRequestHeader("Content-Type","application/json");
                xhrObj.setRequestHeader("Content-Type","application/octet-stream");
                xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
            },

            type: "POST",

            // Request body.
            data: '{"url": ' + '"' + makeblob(sourceImageUrl) + '"}',
        })

        .done(function(data) {
            // Show formatted JSON on webpage.
            $("#responseTextArea").val(JSON.stringify(data, null, 2));
        })

        .fail(function(jqXHR, textStatus, errorThrown) {
            // Display error message.
            var errorString = (errorThrown === "") ?
                "Error. " : errorThrown + " (" + jqXHR.status + "): ";
            errorString += (jqXHR.responseText === "") ?
                "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                    jQuery.parseJSON(jqXHR.responseText).message :
                        jQuery.parseJSON(jqXHR.responseText).error.message;
            alert(errorString);
        });
      }

  </script>
</html>
